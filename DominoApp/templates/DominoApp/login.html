{% extends "DominoApp/base.html" %}

{% block title %}Logowanie - System Domino{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 70vh;">
        <div class="col-md-5 col-lg-4">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="display-6 fw-bold text-primary mb-2">Domino</div>
                        <p class="text-muted">Zaloguj się do panelu zarządzania</p>
                    </div>

                    <div id="error-box" class="alert alert-danger d-none animate__animated animate__fadeIn" role="alert">
                        <small id="error-message"></small>
                    </div>

                    <form id="login-form">
                        {% csrf_token %}
                        
                        <div class="form-floating mb-3">
                            <input type="email" id="email" class="form-control shadow-none" placeholder="name@example.com" required>
                            <label for="email">Adres Email</label>
                        </div>

                        <div class="form-floating mb-4">
                            <input type="password" id="password" class="form-control shadow-none" placeholder="Hasło" required>
                            <label for="password">Hasło</label>
                        </div>

                        <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" type="submit" id="login-btn">
                            <span id="btn-text">Zaloguj się</span>
                            <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>
                </div>
                <div class="card-footer bg-light border-0 py-3 text-center rounded-bottom-4">
                    <small class="text-muted">Problem z dostępem? Skontaktuj się z administratorem.</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const errorBox = document.getElementById("error-box");
    const errorMessage = document.getElementById("error-message");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");
    const loginBtn = document.getElementById("login-btn");

    loginBtn.disabled = true;
    btnText.classList.add("d-none");
    btnSpinner.classList.remove("d-none");
    errorBox.classList.add("d-none");

    try {
        const response = await fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                UserEmail: email,
                UserPassword: password
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || "Nieprawidłowe dane logowania");
        }

        // Zapisywanie danych sesji w przeglądarce
        localStorage.setItem("authToken", data.token);
        localStorage.setItem("userRole", data.role);
        localStorage.setItem("userId", data.userId);

        // Przekierowanie po sukcesie
        window.location.href = "/dashboard/";

    } catch (err) {
        errorMessage.textContent = err.message;
        errorBox.classList.remove("d-none");
        
        // Przywrócenie przycisku
        loginBtn.disabled = false;
        btnText.classList.remove("d-none");
        btnSpinner.classList.add("d-none");
    }
});
</script>

<style>
    /* Opcjonalne delikatne przejścia i dopieszczenie wyglądu */
    body {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }
    .card {
        transition: transform 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}