{% extends "DominoApp/base.html" %}

{% block title %}Logowanie - System Domino{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="col-md-5 col-lg-4">
            <div class="card shadow-sm border-0" style="border-radius: 32px;">
                <div class="card-body p-5">
                    <div class="text-center mb-5">
                        <div class="h2 fw-bolder text-dark mb-2" style="letter-spacing: -1px;">DOMINO</div>
                        <p class="text-muted small">Wprowadź dane, aby zarządzać nieruchomościami</p>
                    </div>

                    <div id="error-box" class="alert alert-danger d-none border-0 rounded-4" role="alert">
                        <small id="error-message"></small>
                    </div>

                    <form id="login-form">
                        {% csrf_token %}
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted ps-2">Email</label>
                            <input type="email" id="email" class="form-control" placeholder="Twój adres email" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold text-muted ps-2">Hasło</label>
                            <input type="password" id="password" class="form-control" placeholder="••••••••" required>
                        </div>

                        <button class="btn btn-primary w-100 py-3" type="submit" id="login-btn">
                            <span id="btn-text">Zaloguj się</span>
                            <span id="btn-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </form>
                </div>
                <div class="card-footer bg-transparent border-0 py-4 text-center">
                    <small class="text-muted">Problem z kontem? Przykro</a></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById("login-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const errorBox = document.getElementById("error-box");
    const errorMessage = document.getElementById("error-message");
    const btnText = document.getElementById("btn-text");
    const btnSpinner = document.getElementById("btn-spinner");
    const loginBtn = document.getElementById("login-btn");

    loginBtn.disabled = true;
    btnText.classList.add("d-none");
    btnSpinner.classList.remove("d-none");
    errorBox.classList.add("d-none");

    try {
        const response = await fetch("/api/login/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                UserEmail: email,
                UserPassword: password
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || "Nieprawidłowe dane logowania");
        }

        localStorage.setItem("authToken", data.token);
        localStorage.setItem("userRole", data.role);
        localStorage.setItem("userId", data.userId);

        window.location.href = "/dashboard/";

    } catch (err) {
        errorMessage.textContent = err.message;
        errorBox.classList.remove("d-none");
        
        loginBtn.disabled = false;
        btnText.classList.remove("d-none");
        btnSpinner.classList.add("d-none");
    }
});
</script>
{% endblock %}