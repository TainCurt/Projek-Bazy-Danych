{% extends "DominoApp/base.html" %}

{% block title %}Statystyki Zadłużeń{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-1">Statystyki Zadłużeń</h2>
        <div class="text-muted">Lista lokali z zaległościami finansowymi</div>
    </div>
    <div class="d-flex gap-2">
        <a href="/dashboard/" class="btn btn-outline-secondary btn-sm"> Powrót</a>
    </div>
</div>

<div id="errorBox" class="alert alert-danger d-none"></div>

<div class="card shadow-sm border-0 mb-3">
    <div class="card-body d-flex flex-column flex-md-row gap-2 align-items-md-end justify-content-between">
        <div class="d-flex flex-column">
            <label class="form-label mb-1">Próg zadłużenia (zł)</label>
            <input type="number" id="thresholdInput" class="form-control" value="2000" style="max-width: 220px;">
        </div>

        <button onclick="loadDebtStats()" class="btn btn-outline-primary">Odśwież</button>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light"> <tr>
                        <th>Adres budynku</th>
                        <th class="text-center">Nr lokalu</th>
                        <th>Całkowity dług</th>
                        <th>Właściciele</th>
                        <th>Najemcy</th>
                    </tr>
                </thead>
                <tbody id="debtTableBody">
                    <tr><td colspan="5" class="text-center py-4 text-muted">Ładowanie...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem("authToken");

function showError(msg) {
    const b = document.getElementById("errorBox");
    if(b) {
        b.classList.remove("d-none");
        b.innerText = msg;
    }
}

async function loadDebtStats() {
    const threshold = document.getElementById("thresholdInput").value;
    const tbody = document.getElementById("debtTableBody");
    const errorBox = document.getElementById("errorBox");
    
    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Ładowanie...</td></tr>';
    if (errorBox) errorBox.classList.add("d-none");

    try {
        const response = await fetch(`/api/flatsrentstats/?threshold=${threshold}`, {
            headers: { 
                "Authorization": "Token " + token,
                "Content-Type": "application/json"
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Błąd pobierania danych");
        }

        const data = await response.json();
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-muted">Brak dłużników powyżej ${threshold} zł.</td></tr>`;
            return;
        }

        data.forEach(item => {
            const owners = item.owners.length > 0 ? item.owners.join("<br>") : "-";
            const tenants = item.tenants.length > 0 ? item.tenants.join("<br>") : "-";

            tbody.innerHTML += `
                <tr>
                    <td class="small text-muted">${item.building_address}</td>
                    <td class="fw-bold text-center">${item.flat_number}</td>
                    <td class="text-danger fw-bold">${parseFloat(item.total_debt).toFixed(2)} zł</td>
                    <td class="small">${owners}</td>
                    <td class="small">${tenants}</td>
                </tr>
            `;
        });
    } catch (error) {
        showError(error.message);
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4 small">Błąd ładowania danych.</td></tr>`;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const role = localStorage.getItem("userRole");
    if (role !== "ADMIN") {
        window.location.href = "/dashboard/";
        return;
    }
    loadDebtStats();
});
</script>
{% endblock %}